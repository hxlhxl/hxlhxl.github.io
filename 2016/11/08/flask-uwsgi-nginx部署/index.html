<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="copy_paste_4_living"><title>flask-uwsgi-nginx部署 | lilyzt</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">flask-uwsgi-nginx部署</h1><a id="logo" href="/.">lilyzt</a><p class="description">copying&amp;pasting-&gt;living</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">flask-uwsgi-nginx部署</h1><div class="post-meta">Nov 8, 2016<span> | </span><span class="category"><a href="/categories/init/">init</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#flask-app"><span class="toc-number">1.</span> <span class="toc-text">flask app</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装、使用uwsgi"><span class="toc-number">2.</span> <span class="toc-text">安装、使用uwsgi</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#wsgi"><span class="toc-number">2.1.</span> <span class="toc-text">wsgi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uwsgi-http"><span class="toc-number">2.2.</span> <span class="toc-text">uwsgi http</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uwsgi-http-socket"><span class="toc-number">2.3.</span> <span class="toc-text">uwsgi http-socket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uwsgi-socket-ip-port"><span class="toc-number">2.4.</span> <span class="toc-text">uwsgi socket ip:port</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uwsgi-socket-socket-file"><span class="toc-number">2.5.</span> <span class="toc-text">uwsgi socket socket file</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#uwsgi-nginx"><span class="toc-number">3.</span> <span class="toc-text">uwsgi + nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#方式一"><span class="toc-number">3.1.</span> <span class="toc-text">方式一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方式二"><span class="toc-number">3.2.</span> <span class="toc-text">方式二</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方式三"><span class="toc-number">3.3.</span> <span class="toc-text">方式三</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方式四"><span class="toc-number">3.4.</span> <span class="toc-text">方式四</span></a></li></ol></li></ol></div></div><div class="post-content"><p>如何使用uwsgi、nginx部署flask app</p>
<h1 id="flask-app"><a href="#flask-app" class="headerlink" title="flask app"></a>flask app</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># coding: utf8</span></div><div class="line"></div><div class="line"><span class="comment"># /search/service/nginx/html/opWeb/index.py</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line"><span class="keyword">from</span> flask.ext.script <span class="keyword">import</span> Manager</div><div class="line"></div><div class="line"><span class="keyword">import</span> ldap</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line">manager = Manager(app)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.route("/")</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"hexo"</span></div><div class="line"></div><div class="line"><span class="meta">@app.route("/hexo")</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hexo</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">"hexo"</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    manager.run()</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /search/service/nginx/html/opWeb/start_opweb.sh</span></div><div class="line">python index.py runserver --host 0.0.0.0 --port 6555 --debug --reload</div><div class="line"></div><div class="line">cat &lt;&lt; EOF &gt; /dev/null</div><div class="line">optional arguments:</div><div class="line">  -?, --help            show this <span class="built_in">help</span> message and <span class="built_in">exit</span></div><div class="line">  -h HOST, --host HOST</div><div class="line">  -p PORT, --port PORT</div><div class="line">  --threaded</div><div class="line">  --processes PROCESSES</div><div class="line">  --passthrough-errors</div><div class="line">  <span class="_">-d</span>, --debug           <span class="built_in">enable</span> the Werkzeug debugger (DO NOT use <span class="keyword">in</span> production</div><div class="line">                        code)</div><div class="line">  -D, --no-debug        <span class="built_in">disable</span> the Werkzeug debugger</div><div class="line">  -r, --reload          monitor Python files <span class="keyword">for</span> changes (not 100&#123;<span class="string">'const'</span>:</div><div class="line">                        True, <span class="string">'help'</span>: <span class="string">'monitor Python files for changes (not</span></div><div class="line">                        100% safe for production use)', <span class="string">'option_strings'</span>:</div><div class="line">                        [<span class="string">'-r'</span>, <span class="string">'--reload'</span>], <span class="string">'dest'</span>: <span class="string">'use_reloader'</span>,</div><div class="line">                        <span class="string">'required'</span>: False, <span class="string">'nargs'</span>: 0, <span class="string">'choices'</span>: None,</div><div class="line">                        <span class="string">'default'</span>: None, <span class="string">'prog'</span>: <span class="string">'index.py runserver'</span>,</div><div class="line">                        <span class="string">'container'</span>: &lt;argparse._ArgumentGroup object at</div><div class="line">                        0x7feaab483ed0&gt;, <span class="string">'type'</span>: None, <span class="string">'metavar'</span>: None&#125;afe <span class="keyword">for</span></div><div class="line">                        production use)</div><div class="line">  -R, --no-reload       <span class="keyword">do</span> not monitor Python files <span class="keyword">for</span> changes</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>python环境为pyenv安装的Python 2.7.12</p>
<p>切换到特定用户(Python 2.7.12环境)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 启动脚本</span></div><div class="line">$ sh start_opweb.sh</div><div class="line">/home/guest/.pyenv/versions/2.7.12/lib/python2.7/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.script is deprecated, use flask_script instead.</div><div class="line">  .format(x=modname), ExtDeprecationWarning</div><div class="line">auth fail</div><div class="line">auth success</div><div class="line"> * Running on http://0.0.0.0:6555/ (Press CTRL+C to quit)</div><div class="line"> * Restarting with <span class="built_in">stat</span></div><div class="line">/home/guest/.pyenv/versions/2.7.12/lib/python2.7/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.script is deprecated, use flask_script instead.</div><div class="line">  .format(x=modname), ExtDeprecationWarning</div><div class="line">auth fail</div><div class="line">auth success</div><div class="line"> * Debugger is active!</div><div class="line"> * Debugger pin code: 934-549-734</div><div class="line"> <span class="comment"># 响应日志</span></div><div class="line">127.0.0.1 - - [08/Nov/2016 23:56:33] <span class="string">"GET /hexo HTTP/1.1"</span> 200 - </div><div class="line"> </div><div class="line"> <span class="comment"># 请求服务</span></div><div class="line">$ curl <span class="string">"http://127.0.0.1:6555/hexo"</span></div><div class="line">hexo</div></pre></td></tr></table></figure>
<h1 id="安装、使用uwsgi"><a href="#安装、使用uwsgi" class="headerlink" title="安装、使用uwsgi"></a>安装、使用uwsgi</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">su - guest</div><div class="line">$ pip install uwsgi -i https://pypi.douban.com/simple</div></pre></td></tr></table></figure>
<h2 id="wsgi"><a href="#wsgi" class="headerlink" title="wsgi"></a>wsgi</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># coding: utf8</span></div><div class="line"></div><div class="line"><span class="comment"># /search/service/nginx/html/opWeb/wsgi.py</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> index <span class="keyword">import</span> app</div></pre></td></tr></table></figure>
<h2 id="uwsgi-http"><a href="#uwsgi-http" class="headerlink" title="uwsgi http"></a>uwsgi http</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; http-opWeb.ini</span></div><div class="line"><span class="section">[uwsgi]</span></div><div class="line"><span class="attr">http</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6555</span></div><div class="line"><span class="comment">; 这里要使用socket,使用http-socket或者http都会使nginx不能和Nginx通信</span></div><div class="line"><span class="attr">stats</span> = :<span class="number">9092</span></div><div class="line"><span class="attr">wsgi-file</span> = /search/service/nginx/html/opWeb/wsgi.py</div><div class="line"><span class="comment">; 这里要使用绝对路径,我操</span></div><div class="line"><span class="attr">callable</span> = app</div><div class="line"><span class="attr">uid</span> = guest</div><div class="line"><span class="attr">gid</span> = guest</div><div class="line"><span class="attr">chdir</span> = /search/service/nginx/html/opWeb</div><div class="line"><span class="attr">master</span> = <span class="literal">true</span></div><div class="line"><span class="attr">processes</span> = <span class="number">4</span></div><div class="line"><span class="attr">pidfile</span> = /var/run/uwsgi/opWeb.pid</div><div class="line"><span class="attr">daemonize</span> = /search/service/uwsgi/logs/uwsgi_opWeb.log</div></pre></td></tr></table></figure>
<p>使用uwsgi启动python app时，必须在guest用户下，因为只有guest用户下才有uwsgi程序和相应的flask环境，因此上面非常重要的一点是指定uid和gid为guest用户。</p>
<p>另外，需要修改对应目录、文件的属主数组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ chown -R guest.guest /var/run/uwsgi/</div><div class="line">$ chown -R guest.guest /search/service/uwsgi/logs/</div><div class="line">$ chown -R guest.guest /search/service/nginx/html/opWeb</div></pre></td></tr></table></figure>
<p>还有一点需要注意，坑死老子了，就是<strong>wsgi-file最好使用 绝对路径</strong></p>
<p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">uwsgi http-opWeb.ini</div><div class="line">$ curl <span class="string">"http://127.0.0.1:6555/hexo"</span></div><div class="line">hexo</div><div class="line"><span class="comment"># 以下为日志</span></div><div class="line">*** Starting uWSGI 2.0.14 (64bit) on [Wed Nov  9 00:09:41 2016] ***</div><div class="line">compiled with version: 4.4.7 20120313 (Red Hat 4.4.7-17) on 08 November 2016 21:45:00</div><div class="line">os: Linux-2.6.32-431.11.25.el6.ucloud.x86_64 <span class="comment">#1 SMP Tue Jul 19 10:06:12 EDT 2016</span></div><div class="line">nodename: opdev</div><div class="line">machine: x86_64</div><div class="line">clock <span class="built_in">source</span>: unix</div><div class="line">detected number of CPU cores: 1</div><div class="line">current working directory: /search/service/nginx/html/opWeb</div><div class="line">writing pidfile to /var/run/uwsgi/opWeb.pid</div><div class="line">detected binary path: /home/guest/.pyenv/versions/2.7.12/bin/uwsgi</div><div class="line">!!! no internal routing support, rebuild with pcre support !!!</div><div class="line"><span class="built_in">chdir</span>() to /search/service/nginx/html/opWeb</div><div class="line">your processes number <span class="built_in">limit</span> is 1024</div><div class="line">your memory page size is 4096 bytes</div><div class="line">detected max file descriptor number: 1000000</div><div class="line">lock engine: pthread robust mutexes</div><div class="line">thunder lock: disabled (you can <span class="built_in">enable</span> it with --thunder-lock)</div><div class="line">uWSGI http bound on 127.0.0.1:6555 fd 4</div><div class="line">uwsgi socket 0 bound to TCP address 127.0.0.1:60310 (port auto-assigned) fd 3</div><div class="line">Python version: 2.7.12 (default, Oct 28 2016, 09:29:48)  [GCC 4.4.7 20120313 (Red Hat 4.4.7-17)]</div><div class="line">*** Python threads support is disabled. You can <span class="built_in">enable</span> it with --enable-threads ***</div><div class="line">Python main interpreter initialized at 0x17b8690</div><div class="line">your server socket listen backlog is limited to 100 connections</div><div class="line">your mercy <span class="keyword">for</span> graceful operations on workers is 60 seconds</div><div class="line">mapped 363840 bytes (355 KB) <span class="keyword">for</span> 4 cores</div><div class="line">*** Operational MODE: preforking ***</div><div class="line">/home/guest/.pyenv/versions/2.7.12/lib/python2.7/site-packages/flask/exthook.py:71: ExtDeprecationWarning: Importing flask.ext.script is deprecated, use flask_script instead.</div><div class="line">  .format(x=modname), ExtDeprecationWarning</div><div class="line">WSGI app 0 (mountpoint=<span class="string">''</span>) ready <span class="keyword">in</span> 1 seconds on interpreter 0x17b8690 pid: 15838 (default app)</div><div class="line">*** uWSGI is running <span class="keyword">in</span> multiple interpreter mode ***</div><div class="line">spawned uWSGI master process (pid: 15838)</div><div class="line">spawned uWSGI worker 1 (pid: 15877, cores: 1)</div><div class="line">spawned uWSGI worker 2 (pid: 15878, cores: 1)</div><div class="line">spawned uWSGI worker 3 (pid: 15879, cores: 1)</div><div class="line">spawned uWSGI worker 4 (pid: 15880, cores: 1)</div><div class="line">*** Stats server enabled on :9092 fd: 18 ***</div><div class="line">spawned uWSGI http 1 (pid: 15881)</div><div class="line">[pid: 15880|app: 0|req: 1/1] 127.0.0.<span class="function"><span class="title">1</span></span> () &#123;28 vars <span class="keyword">in</span> 394 bytes&#125; [Wed Nov  9 00:10:29 2016] GET /hexo =&gt; generated 4 bytes <span class="keyword">in</span> 2 msecs (HTTP/1.1 200) 2 headers <span class="keyword">in</span> 78 bytes (1 switches on core 0)</div><div class="line"><span class="comment"># 上面这条就是响应</span></div></pre></td></tr></table></figure>
<h2 id="uwsgi-http-socket"><a href="#uwsgi-http-socket" class="headerlink" title="uwsgi http-socket"></a>uwsgi http-socket</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; httpsocket-opWeb.ini</span></div><div class="line"><span class="section">[uwsgi]</span></div><div class="line"><span class="attr">http-socket</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6555</span></div><div class="line"><span class="comment">; 这里要使用socket,使用http-socket或者http都会使nginx不能和Nginx通信</span></div><div class="line"><span class="attr">stats</span> = :<span class="number">9092</span></div><div class="line"><span class="attr">wsgi-file</span> = /search/service/nginx/html/opWeb/wsgi.py</div><div class="line"><span class="comment">; 这里要使用绝对路径,我操</span></div><div class="line"><span class="attr">callable</span> = app</div><div class="line"><span class="attr">uid</span> = guest</div><div class="line"><span class="attr">gid</span> = guest</div><div class="line"><span class="attr">chdir</span> = /search/service/nginx/html/opWeb</div><div class="line"><span class="attr">master</span> = <span class="literal">true</span></div><div class="line"><span class="attr">processes</span> = <span class="number">4</span></div><div class="line"><span class="attr">pidfile</span> = /var/run/uwsgi/opWeb.pid</div><div class="line"><span class="attr">daemonize</span> = /search/service/uwsgi/logs/uwsgi_opWeb.log</div></pre></td></tr></table></figure>
<p>这里只改动了http为http-socket，依然可以通过6555端口使用http协议访问</p>
<h2 id="uwsgi-socket-ip-port"><a href="#uwsgi-socket-ip-port" class="headerlink" title="uwsgi socket ip:port"></a>uwsgi socket ip:port</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; socket-opWeb.ini</span></div><div class="line"><span class="section">[uwsgi]</span></div><div class="line"><span class="attr">socket</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6555</span></div><div class="line"><span class="comment">; 这里要使用socket,使用http-socket或者http都会使nginx不能和Nginx通信</span></div><div class="line"><span class="attr">stats</span> = :<span class="number">9092</span></div><div class="line"><span class="attr">wsgi-file</span> = /search/service/nginx/html/opWeb/wsgi.py</div><div class="line"><span class="comment">; 这里要使用绝对路径,我操</span></div><div class="line"><span class="attr">callable</span> = app</div><div class="line"><span class="attr">uid</span> = guest</div><div class="line"><span class="attr">gid</span> = guest</div><div class="line"><span class="attr">chdir</span> = /search/service/nginx/html/opWeb</div><div class="line"><span class="attr">master</span> = <span class="literal">true</span></div><div class="line"><span class="attr">processes</span> = <span class="number">4</span></div><div class="line"><span class="attr">pidfile</span> = /var/run/uwsgi/opWeb.pid</div><div class="line"><span class="attr">daemonize</span> = /search/service/uwsgi/logs/uwsgi_opWeb.log</div></pre></td></tr></table></figure>
<p>这里修改httpsocket为socket，仍然可以通过http形式访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># uwsgi socket 0 bound to TCP address 127.0.0.1:6555 fd 3</span></div><div class="line">$ curl <span class="string">"http://127.0.0.1:6555/hexo"</span></div><div class="line">hexo</div></pre></td></tr></table></figure>
<h2 id="uwsgi-socket-socket-file"><a href="#uwsgi-socket-socket-file" class="headerlink" title="uwsgi socket socket file"></a>uwsgi socket socket file</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; socketfile-opWeb.ini</span></div><div class="line"><span class="section">[uwsgi]</span></div><div class="line"><span class="attr">socket</span> = /var/run/uwsgi/uwsgi.sock</div><div class="line"><span class="comment">; 这里要使用socket,使用http-socket或者http都会使nginx不能和Nginx通信</span></div><div class="line"><span class="attr">stats</span> = :<span class="number">9092</span></div><div class="line"><span class="comment">; stats表示uwsgi的统计服务端口</span></div><div class="line"><span class="attr">wsgi-file</span> = /search/service/nginx/html/opWeb/wsgi.py</div><div class="line"><span class="comment">; 这里要使用绝对路径,我操</span></div><div class="line"><span class="attr">callable</span> = app</div><div class="line"><span class="attr">uid</span> = guest</div><div class="line"><span class="attr">gid</span> = guest</div><div class="line"><span class="attr">chdir</span> = /search/service/nginx/html/opWeb</div><div class="line"><span class="attr">master</span> = <span class="literal">true</span></div><div class="line"><span class="attr">processes</span> = <span class="number">4</span></div><div class="line"><span class="attr">pidfile</span> = /var/run/uwsgi/opWeb.pid</div><div class="line"><span class="attr">daemonize</span> = /search/service/uwsgi/logs/uwsgi_opWeb.log</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># uwsgi socket 0 bound to UNIX address /var/run/uwsgi/uwsgi.sock fd 3</span></div><div class="line"></div><div class="line">curl <span class="string">"http://127.0.0.1:6555/hexo"</span></div><div class="line">curl: (7) couldn<span class="string">'t connect to host</span></div></pre></td></tr></table></figure>
<h1 id="uwsgi-nginx"><a href="#uwsgi-nginx" class="headerlink" title="uwsgi + nginx"></a>uwsgi + nginx</h1><h2 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h2><p><strong>http = 127.0.0.1:6555</strong>方式启动</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attribute">uWSGI</span> http bound <span class="literal">on</span> <span class="number">127.0.0.1:6555</span> fd <span class="number">4</span></div><div class="line">uwsgi socket <span class="number">0</span> bound to TCP address <span class="number">127.0.0.1:56228</span> (port auto-assigned) fd <span class="number">3</span></div><div class="line"></div><div class="line">$ ss -ntl</div><div class="line">State      Recv-Q Send-Q                         Local Address:Port                           Peer Address:Port</div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                                        *:<span class="number">80</span>                                        *:*</div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                                       :::<span class="number">22</span>                                       :::*</div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">128</span>                                        *:<span class="number">22</span>                                        *:*</div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>                                <span class="number">127.0.0.1:6555</span>                                      *:*</div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>                                        *:<span class="number">9092</span>                                      *:*</div><div class="line">LISTEN     <span class="number">0</span>      <span class="number">100</span>                                <span class="number">127.0.0.1:56228</span>                                     *:*</div></pre></td></tr></table></figure>
<p>可以看到在启动http服务的同时也启动了一个TCP socket，</p>
<p>在这里，如果把Nginx的uwsgi_pass修改为<strong>127.0.0.1:56228</strong>那么client还是可以访问flask web页面的，但是如果使用默认的6555就是一个http协议的端口，Nginx无法代理。</p>
<h2 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h2><p><strong>http-socket = 127.0.0.1:6555</strong>方式启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">uwsgi socket 0 bound to TCP address 127.0.0.1:6555 fd 3</div><div class="line"></div><div class="line"></div><div class="line">LISTEN     0      100                                127.0.0.1:6555                                      *:*</div></pre></td></tr></table></figure>
<p>这种方式client访问将会出现502错误</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">120</span><span class="variable">.52</span><span class="variable">.92</span><span class="variable">.188</span> - - [<span class="number">09</span>/Nov/<span class="number">2016</span>:<span class="number">00</span>:<span class="number">59</span>:<span class="number">32</span> +<span class="number">0800</span>] <span class="string">"GET /hexo HTTP/1.1"</span> <span class="number">502</span> <span class="number">575</span> <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.71 Safari/537.36"</span> <span class="string">"-"</span></div><div class="line">  </div><div class="line"># Nginx错误日志</div><div class="line">  </div><div class="line">  <span class="number">2016</span>/<span class="number">11</span>/<span class="number">09</span> <span class="number">00</span>:<span class="number">59</span>:<span class="number">31</span> [error] <span class="number">22256</span>#<span class="number">0</span>: *<span class="number">1</span> upstream prematurely closed connection <span class="keyword">while</span> reading response header from upstream, client: <span class="number">120</span><span class="variable">.52</span><span class="variable">.92</span><span class="variable">.188</span>, server: lilyzt<span class="variable">.com</span>, request: <span class="string">"GET /hexo HTTP/1.1"</span>, upstream: <span class="string">"uwsgi://127.0.0.1:6555"</span>, host: <span class="string">"lilyzt.com"</span></div></pre></td></tr></table></figure>
<p>而且uwsgi服务根本没有和Nginx产生任何的交互</p>
<p>那么Nginx正确的配置方式应该是使用http协议而不再是uwsgi协议</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">upstream</span> httpsocket_uwsgi &#123;</div><div class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:6555</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="section">server</span> &#123;</div><div class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">    <span class="attribute">server_name</span>  lilyzt.com;</div><div class="line">    <span class="attribute">client_max_body_size</span> <span class="number">16m</span>;</div><div class="line">    <span class="attribute">client_body_buffer_size</span> <span class="number">256k</span>;</div><div class="line"></div><div class="line">    <span class="attribute">proxy_buffering</span>     <span class="literal">on</span>;</div><div class="line">    <span class="attribute">proxy_buffer_size</span>   <span class="number">4k</span>;</div><div class="line">    <span class="attribute">proxy_buffers</span>   <span class="number">8</span>   <span class="number">32k</span>;</div><div class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</div><div class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">0</span>;</div><div class="line">    <span class="attribute">location</span> <span class="regexp">~ /</span> &#123;</div><div class="line">      <span class="attribute">root</span> /search/service/nginx/html/opWeb;</div><div class="line">      <span class="attribute">access_log</span>  /search/service/nginx/logs/opWeb.log main;</div><div class="line">      <span class="attribute">proxy_pass</span> http://httpsocket_uwsgi;</div><div class="line">      <span class="comment">#uwsgi_pass 127.0.0.1:6555;  # 指向uwsgi 所应用的内部地址,所有请求将转发给uwsgi 处理</span></div><div class="line">      <span class="comment">#uwsgi_param UWSGI_CHDIR  /search/service/nginx/html/opWeb; # 指向网站根目录</span></div><div class="line">      <span class="comment">#uwsgi_connect_timeout 600;</span></div><div class="line">      <span class="comment">#uwsgi_read_timeout 600;</span></div><div class="line">      <span class="comment">#uwsgi_param UWSGI_MODULE index;</span></div><div class="line">      <span class="comment">#uwsgi_param UWSGI_CALLABLE app;</span></div><div class="line">      <span class="comment">#include     uwsgi_params;</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上这种配置就能正常的访问flask web提供的服务了</p>
<h2 id="方式三"><a href="#方式三" class="headerlink" title="方式三"></a>方式三</h2><p><strong>socket = 127.0.0.1:6555</strong> 方式</p>
<p>这种方式下Nginx的配置如下:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="section">server</span> &#123;</div><div class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">    <span class="attribute">server_name</span>  lilyzt.com;</div><div class="line">    <span class="attribute">client_max_body_size</span> <span class="number">16m</span>;</div><div class="line">    <span class="attribute">client_body_buffer_size</span> <span class="number">256k</span>;</div><div class="line"></div><div class="line">    <span class="attribute">proxy_buffering</span>     <span class="literal">on</span>;</div><div class="line">    <span class="attribute">proxy_buffer_size</span>   <span class="number">4k</span>;</div><div class="line">    <span class="attribute">proxy_buffers</span>   <span class="number">8</span>   <span class="number">32k</span>;</div><div class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</div><div class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">0</span>;</div><div class="line">    <span class="attribute">location</span> <span class="regexp">~ /</span> &#123;</div><div class="line">      <span class="attribute">root</span> /search/service/nginx/html/opWeb;</div><div class="line">      <span class="attribute">access_log</span>  /search/service/nginx/logs/opWeb.log main;</div><div class="line">      <span class="attribute">uwsgi_pass</span> <span class="number">127.0.0.1:6555</span>;  <span class="comment"># 指向uwsgi 所应用的内部地址,所有请求将转发给uwsgi 处理</span></div><div class="line">      <span class="attribute">uwsgi_param</span> UWSGI_CHDIR  /search/service/nginx/html/opWeb; <span class="comment"># 指向网站根目录</span></div><div class="line">      <span class="attribute">uwsgi_connect_timeout</span> <span class="number">600</span>;</div><div class="line">      <span class="attribute">uwsgi_read_timeout</span> <span class="number">600</span>;</div><div class="line">      <span class="attribute">uwsgi_param</span> UWSGI_MODULE index;</div><div class="line">      <span class="attribute">uwsgi_param</span> UWSGI_CALLABLE app;</div><div class="line">      <span class="attribute">include</span>     uwsgi_params;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="方式四"><a href="#方式四" class="headerlink" title="方式四"></a>方式四</h2><p><strong>socket = /var/run/uwsgi/uwsgi.sock</strong>方式</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">; socketfile-opWeb.ini</span></div><div class="line"><span class="section">[uwsgi]</span></div><div class="line"><span class="attr">socket</span> = /var/run/uwsgi/uwsgi.sock</div><div class="line"><span class="comment">; 这里要使用socket,使用http-socket或者http都会使nginx不能和Nginx通信</span></div><div class="line"><span class="attr">stats</span> = :<span class="number">9092</span></div><div class="line"><span class="comment">; stats表示uwsgi的统计服务端口</span></div><div class="line"><span class="attr">wsgi-file</span> = /search/service/nginx/html/opWeb/wsgi.py</div><div class="line"><span class="comment">; 这里要使用绝对路径,我操</span></div><div class="line"><span class="attr">callable</span> = app</div><div class="line"><span class="attr">uid</span> = guest</div><div class="line"><span class="attr">gid</span> = guest</div><div class="line"><span class="attr">chdir</span> = /search/service/nginx/html/opWeb</div><div class="line"><span class="attr">master</span> = <span class="literal">true</span></div><div class="line"><span class="attr">processes</span> = <span class="number">4</span></div><div class="line"><span class="attr">pidfile</span> = /var/run/uwsgi/opWeb.pid</div><div class="line"><span class="attr">daemonize</span> = /search/service/uwsgi/logs/uwsgi_opWeb.log</div></pre></td></tr></table></figure>
<p><strong>这里要记得修改/var/run/uwsgi/的属主数组</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ chown -R guest.guest /var/run/uwsgi/</div></pre></td></tr></table></figure>
<p>启动uwsgi</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[guest@opdev opWeb]$ uwsgi socketfile-opWeb.ini</div><div class="line">[uWSGI] getting INI configuration from socketfile-opWeb.ini</div><div class="line"></div><div class="line">LISTEN     0      100                                        *:9092                                      *:*</div><div class="line"></div><div class="line"><span class="comment"># uwsgi socket 0 bound to UNIX address /var/run/uwsgi/uwsgi.sock fd 3</span></div></pre></td></tr></table></figure>
<p>这种方式启动并不会开启TCP端口监听</p>
<p>因此Nginx的配置应该如下:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="section">server</span> &#123;</div><div class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">    <span class="attribute">server_name</span>  lilyzt.com;</div><div class="line">    <span class="attribute">client_max_body_size</span> <span class="number">16m</span>;</div><div class="line">    <span class="attribute">client_body_buffer_size</span> <span class="number">256k</span>;</div><div class="line"></div><div class="line">    <span class="attribute">proxy_buffering</span>     <span class="literal">on</span>;</div><div class="line">    <span class="attribute">proxy_buffer_size</span>   <span class="number">4k</span>;</div><div class="line">    <span class="attribute">proxy_buffers</span>   <span class="number">8</span>   <span class="number">32k</span>;</div><div class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</div><div class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">0</span>;</div><div class="line">    <span class="attribute">location</span> <span class="regexp">~ /</span> &#123;</div><div class="line">      <span class="attribute">root</span> /search/service/nginx/html/opWeb;</div><div class="line">      <span class="attribute">access_log</span>  /search/service/nginx/logs/opWeb.log main;</div><div class="line">      <span class="comment">#proxy_pass http://httpsocket_uwsgi;</span></div><div class="line">      <span class="attribute">uwsgi_pass</span> unix:///var/run/uwsgi/uwsgi.sock;  <span class="comment"># 指向uwsgi 所应用的内部地址,所有请求将转发给uwsgi 处理</span></div><div class="line">      <span class="attribute">uwsgi_param</span> UWSGI_CHDIR  /search/service/nginx/html/opWeb; <span class="comment"># 指向网站根目录</span></div><div class="line">      <span class="attribute">uwsgi_connect_timeout</span> <span class="number">600</span>;</div><div class="line">      <span class="attribute">uwsgi_read_timeout</span> <span class="number">600</span>;</div><div class="line">      <span class="attribute">uwsgi_param</span> UWSGI_MODULE index;</div><div class="line">      <span class="attribute">uwsgi_param</span> UWSGI_CALLABLE app;</div><div class="line">      <span class="attribute">include</span>     uwsgi_params;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面把uwsgi的协议方式修改为了unix socket方式</p>
<p>浪费了老子这么多时间，可是人家早就在文档中写好了，不冷静下来看文档也就只能到处搜一下乱七八糟千篇一律浪费时间的玩意儿。</p>
<blockquote>
<p>The <code>http-socket</code> option will make uWSGI natively speak HTTP. If your web server does not support the <a href="http://uwsgi-docs.readthedocs.io/en/latest/Protocol.html" target="_blank" rel="external"><em>uwsgi protocol</em></a> but is able to speak to upstream HTTP proxies, or if you are using a service like Webfaction or Heroku to host your application, you can use <code>http-socket</code>. If you plan to expose your app to the world with uWSGI only, use the <code>http</code> option instead, as the router/proxy/load-balancer will then be your shield.</p>
</blockquote>
<p>人家都说了要么使用socket方式，要么使用http-socket+http方式，要么使用uwsgi裸奔，浪费我时间。</p>
<p>另外，还有一点是uwsgi有的时候也会产生core文件哦~</p>
<p><img src="http://lilyzt.com/hexo/image/heap/2.png" alt="uwsgi core file"></p>
<p><a href="http://uwsgi-docs.readthedocs.io/en/latest/HTTP.html#native-http-support" target="_blank" rel="external">Http Native Support</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://hxlhxl.github.io/2016/11/08/flask-uwsgi-nginx部署/" data-id="cixje4jrs000933g4ees9mdqj" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2016/11/08/jQuery事件绑定之向回调函数传递参数/" class="next">jQuery事件绑定之向回调函数传递参数</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ML/">ML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/init/">init</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/system-admin/">system_admin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webpy/">webpy</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">lilyzt.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>